rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================================================
    // HELPER FUNCTIONS - Authentication & Claims
    // ========================================================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Get user role from custom claims (FAST - cached in token)
    function getRoleFromClaims() {
      return request.auth.token.role;
    }
    
    // Get user role from Firestore (SLOW - document read)
    function getRoleFromFirestore() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc.data.role;
    }
    
    // Check if claims are present and valid
    function hasValidClaims() {
      return isAuthenticated() 
        && request.auth.token.role is string
        && request.auth.token.claimsVersion == 1;
    }
    
    // ========================================================================
    // HELPER FUNCTIONS - Role Checks (PREFER CLAIMS)
    // ========================================================================
    
    // SUPER ADMIN check - uses claims (fast)
    function isSuperAdmin() {
      return isAuthenticated() && getRoleFromClaims() == 'super_admin';
    }
    
    // ADMIN check - uses claims (fast)
    // Note: Returns true for both admin and super_admin
    function isAdmin() {
      return isAuthenticated() 
        && (getRoleFromClaims() == 'admin' || getRoleFromClaims() == 'super_admin');
    }
    
    // STUDENT check - uses claims (fast)
    function isStudent() {
      return isAuthenticated() && getRoleFromClaims() == 'student';
    }
    
    // ========================================================================
    // HELPER FUNCTIONS - Ownership & Access
    // ========================================================================
    
    // Check if user owns the resource (by ownerId field)
    function isOwner(ownerId) {
      return isAuthenticated() && request.auth.uid == ownerId;
    }
    
    // Check if user is trying to access their own document
    function isSelf(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Validate that role is not being changed by non-admin
    function roleNotChanged() {
      return request.resource.data.role == resource.data.role;
    }
    
    // Validate audit fields are not tampered with
    function auditFieldsUnchanged() {
      return request.resource.data._claimsSyncedAt == resource.data._claimsSyncedAt
        && request.resource.data._revertedAt == resource.data._revertedAt
        && request.resource.data._revertReason == resource.data._revertReason;
    }
    
    // ========================================================================
    // HELPER FUNCTIONS - Enrollment Access (DETERMINISTIC MODEL)
    // ========================================================================
    
    /**
     * THE SINGLE SOURCE OF TRUTH for enrollment access
     * 
     * Uses accessGranted field maintained by Cloud Functions.
     * This is a boolean check - no time calculations in rules.
     * 
     * Backward Compatibility:
     * - If accessGranted doesn't exist, falls back to legacy check
     * - This allows gradual migration of existing data
     */
    function hasEnrollmentAccess(enrollmentData) {
      // Primary: Use computed access flag
      if (enrollmentData.accessGranted is bool) {
        return enrollmentData.accessGranted == true;
      }
      
      // Fallback: Legacy time-based check (for enrollments before migration)
      // This will be removed in Phase 4
      return enrollmentData.status == 'active' 
        && enrollmentData.expiresAt.toMillis() > request.time.toMillis();
    }
    
    /**
     * Check if user can view enrollment metadata (not content access)
     */
    function canViewEnrollment(enrollmentData) {
      return isSelf(enrollmentData.studentId) 
        || isOwner(enrollmentData.ownerId) 
        || isSuperAdmin();
    }
    
    /**
     * Check if user can access course content through enrollment
     * This is the strict check used for content access
     */
    function canAccessCourseContent(enrollmentData) {
      return canViewEnrollment(enrollmentData) 
        && hasEnrollmentAccess(enrollmentData);
    }
    
    /**
     * Validate that access fields are only written by service account
     */
    function accessFieldsUnchangedOrServiceAccount() {
      // If access fields not in update, that's fine
      let hasAccessFields = request.resource.data.diff(resource.data).affectedKeys()
        .hasAny(['accessGranted', 'accessComputedAt', 'accessDenialReason']);
      
      if (!hasAccessFields) {
        return true;
      }
      
      // If access fields are being updated, must be service account
      // Note: In production, use a custom claim or specific service account UID
      // For now, we trust that only Cloud Functions will write these fields
      // Additional validation happens in the write rule
      return true;
    }

    // ========================================================================
    // Users Collection
    // ========================================================================
    
    match /users/{userId} {
      allow read: if isSelf(userId) || isSuperAdmin();
      
      allow create: if isSuperAdmin()
                    || (isSelf(userId) 
                        && request.resource.data.role == 'student'
                        && request.resource.data.isActive == true
                        && !request.resource.data.keys().hasAny(['_claimsSyncedAt', '_revertedAt', '_revertReason']));
      
      allow update: if (isSelf(userId) 
                        && roleNotChanged() 
                        && auditFieldsUnchanged()) 
                    || isSuperAdmin();
      
      allow delete: if isSuperAdmin();
    }

    // ========================================================================
    // Courses Collection
    // ========================================================================
    
    match /courses/{courseId} {
      allow read: if resource.data.isPublished == true 
                  || isOwner(resource.data.ownerId) 
                  || isSuperAdmin();
      
      allow create: if (isAdmin() && request.resource.data.ownerId == request.auth.uid) 
                    || isSuperAdmin();
      
      allow update: if (isOwner(resource.data.ownerId) 
                      && request.resource.data.ownerId == resource.data.ownerId) 
                    || isSuperAdmin();
      
      allow delete: if isOwner(resource.data.ownerId) || isSuperAdmin();
    }

    // ========================================================================
    // Enrollments Collection - DETERMINISTIC ACCESS MODEL
    // ========================================================================
    
    match /enrollments/{enrollmentId} {
      
      // ----------------------------------------------------------------------
      // READ OPERATIONS
      // ----------------------------------------------------------------------
      
      // List/Query: Can view enrollment if owner, student, or admin
      // Note: This doesn't check accessGranted - viewing enrollment is different
      // from accessing course content
      allow list: if isAuthenticated(); // Query filters applied by client
      
      // Get: View enrollment details
      // Uses accessGranted for UI state, but allows viewing expired enrollments
      allow get: if canViewEnrollment(resource.data);
      
      // ----------------------------------------------------------------------
      // CREATE OPERATIONS
      // ----------------------------------------------------------------------
      
      // Students can create enrollments for themselves
      // Admin/SuperAdmin can create any enrollment
      allow create: if (isStudent() && request.resource.data.studentId == request.auth.uid) 
                    || isSuperAdmin();
      
      // Validate required fields on create
      allow create: if (request.resource.data.keys().hasAll(['studentId', 'courseId', 'ownerId', 'startDate', 'expiresAt', 'status', 'selectedDuration', 'paymentSlipId', 'pricePaid'])
                    && (isStudent() && request.resource.data.studentId == request.auth.uid)
                    && request.resource.data.status == 'active')
                    || isSuperAdmin();
      
      // ----------------------------------------------------------------------
      // UPDATE OPERATIONS
      // ----------------------------------------------------------------------
      
      // Students can update progress fields
      // SuperAdmin can update anything
      // Note: accessGranted and related fields are protected below
      allow update: if isSuperAdmin()
                    || (isSelf(resource.data.studentId) 
                      && request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['progress', 'overallProgress', 'lastAccessedAt', 'completedAt', 'updatedAt']));
      
      // PROTECTION: accessGranted and related fields can only be updated by service account
      // This is enforced by checking the auth token
      // In practice, only Cloud Functions (with service account) should modify these
      allow update: if !request.resource.data.diff(resource.data).affectedKeys()
                        .hasAny(['accessGranted', 'accessComputedAt', 'accessDenialReason', 'expiredAt'])
                    || isSuperAdmin();
      
      // ----------------------------------------------------------------------
      // DELETE OPERATIONS
      // ----------------------------------------------------------------------
      
      allow delete: if isSuperAdmin();
    }

    // ========================================================================
    // Course Content Access (via enrollment)
    // ========================================================================
    
    // This is used by content security rules to check if student can access
    // Specific course content collections would use this function
    match /courseContent/{courseId}/lessons/{lessonId} {
      // Student can read if they have active enrollment
      allow read: if isAuthenticated()
                  && exists(/databases/$(database)/documents/enrollments/$(request.auth.uid + '_' + courseId))
                  && get(/databases/$(database)/documents/enrollments/$(request.auth.uid + '_' + courseId)).data.accessGranted == true;
      
      // Or use the more generic pattern with query
      // In practice, content access should be checked via enrollment lookup
    }

    // ========================================================================
    // Payment Slips Collection
    // ========================================================================
    
    match /paymentSlips/{slipId} {
      allow read: if isSelf(resource.data.studentId) 
                  || isOwner(resource.data.ownerId) 
                  || isSuperAdmin();
      
      allow create: if isStudent() && request.resource.data.studentId == request.auth.uid;
      
      allow update: if (isOwner(resource.data.ownerId) || isSuperAdmin()) 
                    || (isSelf(resource.data.studentId) && resource.data.status == 'pending');
      
      allow delete: if isSuperAdmin();
    }

    // ========================================================================
    // Reviews Collection
    // ========================================================================
    
    match /reviews/{reviewId} {
      allow read: if resource.data.isPublished == true 
                  || isSelf(resource.data.studentId) 
                  || isOwner(get(/databases/$(database)/documents/courses/$(resource.data.courseId)).data.ownerId)
                  || isSuperAdmin();
      
      // Create: Only students with valid enrollment can review
      // Uses accessGranted for strict check
      allow create: if isStudent() 
                    && request.resource.data.studentId == request.auth.uid
                    && exists(/databases/$(database)/documents/enrollments/$(request.resource.data.enrollmentId))
                    && get(/databases/$(database)/documents/enrollments/$(request.resource.data.enrollmentId)).data.accessGranted == true;
      
      allow update: if isSelf(resource.data.studentId)
                    || (isOwner(get(/databases/$(database)/documents/courses/$(resource.data.courseId)).data.ownerId)
                      && request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['instructorResponse', 'instructorResponseAt', 'updatedAt']))
                    || isSuperAdmin();
      
      allow delete: if isSelf(resource.data.studentId) || isSuperAdmin();
    }

    // ========================================================================
    // Revenue Records Collection
    // ========================================================================
    
    match /revenueRecords/{recordId} {
      allow read: if isOwner(resource.data.ownerId) || isSuperAdmin();
      allow create, update, delete: if isSuperAdmin();
    }

    // ========================================================================
    // Admin Statistics Collection
    // ========================================================================
    
    match /adminStatistics/{userId} {
      allow read: if isSelf(userId) || isSuperAdmin();
      allow create, update, delete: if isSuperAdmin();
    }

    // ========================================================================
    // Platform Statistics Collection
    // ========================================================================
    
    match /platformStatistics/{statId} {
      allow read: if isSuperAdmin();
      allow create, update, delete: if isSuperAdmin();
    }

    // ========================================================================
    // Notifications Collection
    // ========================================================================
    
    match /notifications/{notificationId} {
      allow read: if isSelf(resource.data.userId) || isSuperAdmin();
      allow create: if isSuperAdmin();
      allow update: if (isSelf(resource.data.userId) 
                      && request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['isRead', 'readAt']))
                    || isSuperAdmin();
      allow delete: if isSelf(resource.data.userId) || isSuperAdmin();
    }
    
    // ========================================================================
    // System Metrics (for monitoring)
    // ========================================================================
    
    match /systemMetrics/{metricId} {
      allow read: if isSuperAdmin();
      allow write: if false; // Only Cloud Functions
    }

    // ========================================================================
    // DEFAULT DENY ALL OTHER COLLECTIONS
    // ========================================================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
